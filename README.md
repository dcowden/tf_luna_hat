# This is a hat for an orange pi 5, v1.2, that exposes the uarts and can bus from the headers.


## Setting up the orange pi image

These high level steps are needed:

* Install arm overlays to enable uart 3 and 4
* disable serial gettys on the tty ports for these
* install i2c tools

## unpolished stuff I did
sudo apt update
sudo apt install -y \
  make build-essential libssl-dev zlib1g-dev \
  libbz2-dev libreadline-dev libsqlite3-dev \
  wget curl llvm libncurses5-dev libncursesw5-dev \
  xz-utils tk-dev libffi-dev liblzma-dev python3-pip git

# Install pyenv
curl https://pyenv.run | bash

# Add pyenv to your shell
echo 'export PATH="$HOME/.pyenv/bin:$PATH"' >> ~/.bashrc
echo 'eval "$(pyenv init -)"' >> ~/.bashrc
echo 'eval "$(pyenv virtualenv-init -)"' >> ~/.bashrc
source ~/.bashrc

# Install a specific Python version, e.g. 3.11.9
pyenv install 3.11.9

# Set it as the default for your user
pyenv global 3.11.9

# Verify
python --version
apt install i2c-tools

for b in 0 1 2 3 4 5 6 7 9 10; do echo "=== /dev/i2c-$b ==="; i2cdetect -y $b; done

pyenv virtualenv 3.11.9 i2c
pyenv activate
pyenv install smbus2

sudo usermod -aG i2c $USER
echo 'KERNEL=="i2c-[0-9]*", GROUP="i2c", MODE="0660"' | sudo tee /etc/udev/rules.d/99-i2c.rules
sudo udevadm control --reload-rules
sudo udevadm trigger
newgrp i2c

systemctl status serial-getty@ttyS4.service
# disable if active:
sudo systemctl disable --now serial-getty@ttyS4.service
sudo systemctl mask serial-getty@ttyS4.service
systemctl status serial-getty@ttyS4.service
# disable if active:
sudo systemctl disable --now serial-getty@ttyS3.service
sudo systemctl mask serial-getty@ttyS3.service


u-boot-update

RESULTING SITUATION
root@ubuntu:~# ls -l /lib/firmware/6.1.0-1025-rockchip/device-tree/rockchip/overlay/i2c*
-rw-r--r-- 1 root root 414 Sep  6 23:28 /lib/firmware/6.1.0-1025-rockchip/device-tree/rockchip/overlay/i2c-1.dtbo
-rw-r--r-- 1 root root 414 Sep  6 23:28 /lib/firmware/6.1.0-1025-rockchip/device-tree/rockchip/overlay/i2c-3.dtbo
-rw-r--r-- 1 root root 414 Sep  6 23:28 /lib/firmware/6.1.0-1025-rockchip/device-tree/rockchip/overlay/i2c-5.dtbo
root@ubuntu:~# ls -l /lib/firmware/device-tree/rockchip/overlay/
total 12
-rw-r--r-- 1 root root 414 Sep  6 22:15 i2c-1.dtbo
-rw-r--r-- 1 root root 414 Sep  6 22:15 i2c-3.dtbo
-rw-r--r-- 1 root root 414 Sep  6 22:15 i2c-5.dtbo
root@ubuntu:~# cat /etc/default/u-boot
## /etc/default/u-boot - configuration file for u-boot-update(8)

U_BOOT_UPDATE="true"

#U_BOOT_ALTERNATIVES="default recovery"
#U_BOOT_DEFAULT="l0"
#U_BOOT_PROMPT="1"
#U_BOOT_ENTRIES="all"
#U_BOOT_MENU_LABEL="Debian GNU/Linux"
#U_BOOT_PARAMETERS="ro earlycon"
#U_BOOT_ROOT=""
#U_BOOT_TIMEOUT="50"
U_BOOT_FDT="device-tree/rockchip/rk3588s-orangepi-5.dtb"
U_BOOT_FDT_DIR="/lib/firmware/"
U_BOOT_FDT_OVERLAYS="device-tree/rockchip/overlay/i2c-1.dtbo device-tree/rockchip/overlay/i2c-5.dtbo device-tree/rockchip/overlay/i2c-3.dtbo"
#U_BOOT_FDT_OVERLAYS_DIR="device-tree/rockchip/overlay"
#U_BOOT_SYNC_DTBS="false"
root@ubuntu:~# cat /boot/extlinux/extlinux.conf
## /boot/extlinux/extlinux.conf
##
## IMPORTANT WARNING
##
## The configuration of this file is generated automatically.
## Do not edit this file manually, use: u-boot-update

default l0
menu title U-Boot menu
prompt 1
timeout 20


label l0
        menu label Ubuntu 24.04.1 LTS 6.1.0-1025-rockchip
        linux /boot/vmlinuz-6.1.0-1025-rockchip
        initrd /boot/initrd.img-6.1.0-1025-rockchip
        fdt /lib/firmware/6.1.0-1025-rockchip/device-tree/rockchip/rk3588s-orangepi-5.dtb
        fdtoverlays  /lib/firmware/6.1.0-1025-rockchip/device-tree/rockchip/overlay/i2c-1.dtbo /lib/firmware/6.1.0-1025-rockchip/device-tree/rockchip/overlay/i2c-5.dtbo /lib/firmware/6.1.0-1025-rockchip/device-tree/rockchip/overlay/i2c-3.dtbo
        append root=UUID=cb911622-d31a-45b1-be03-e6467c1b7637 rootwait rw console=ttyS2,1500000 console=tty1 cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory

label l0r
        menu label Ubuntu 24.04.1 LTS 6.1.0-1025-rockchip (rescue target)
        linux /boot/vmlinuz-6.1.0-1025-rockchip
        initrd /boot/initrd.img-6.1.0-1025-rockchip
        fdt /lib/firmware/6.1.0-1025-rockchip/device-tree/rockchip/rk3588s-orangepi-5.dtb
        append root=UUID=cb911622-d31a-45b1-be03-e6467c1b7637 rootwait rw console=ttyS2,1500000 console=tty1 cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory single



root@ubuntu:~# nano /etc/default/u-boot
root@ubuntu:~# root@ubuntu:~# u-boot-update
P: Checking for EXTLINUX directory... found.
P: Writing config for vmlinuz-6.1.0-1025-rockchip...
P: Updating /boot/extlinux/extlinux.conf...
root@ubuntu:~# cat /etc/default/u-boot
## /etc/default/u-boot - configuration file for u-boot-update(8)

U_BOOT_UPDATE="true"

#U_BOOT_ALTERNATIVES="default recovery"
#U_BOOT_DEFAULT="l0"
#U_BOOT_PROMPT="1"
#U_BOOT_ENTRIES="all"
#U_BOOT_MENU_LABEL="Debian GNU/Linux"
#U_BOOT_PARAMETERS="ro earlycon"
#U_BOOT_ROOT=""
#U_BOOT_TIMEOUT="50"
U_BOOT_FDT="device-tree/rockchip/rk3588s-orangepi-5.dtb"
U_BOOT_FDT_DIR="/lib/firmware/"
#U_BOOT_FDT_OVERLAYS="device-tree/rockchip/overlay/i2c-1.dtbo device-tree/rockchip/overlay/i2c-5.dtbo device-tree/rockchip/overlay/i2c-3.dtbo"
#U_BOOT_FDT_OVERLAYS="device-tree/rockchip/overlay/i2c-1.dtbo"
U_BOOT_FDT_OVERLAYS="device-tree/rockchip/overlay/rk3588-uart4-m0.dtbo device-tree/rockchip/overlay/rk3568-uart3-m0.dtbo"
#U_BOOT_FDT_OVERLAYS_DIR="device-tree/rockchip/overlay"
#U_BOOT_SYNC_DTBS="false"
root@ubuntu:~# cat /boot/extlinux/extlinux.conf
## /boot/extlinux/extlinux.conf
##
## IMPORTANT WARNING
##
## The configuration of this file is generated automatically.
## Do not edit this file manually, use: u-boot-update

default l0
menu title U-Boot menu
prompt 1
timeout 20


label l0
        menu label Ubuntu 24.04.1 LTS 6.1.0-1025-rockchip
        linux /boot/vmlinuz-6.1.0-1025-rockchip
        initrd /boot/initrd.img-6.1.0-1025-rockchip
        fdt /lib/firmware/6.1.0-1025-rockchip/device-tree/rockchip/rk3588s-orangepi-5.dtb
        fdtoverlays  /lib/firmware/6.1.0-1025-rockchip/device-tree/rockchip/overlay/rk3588-uart4-m0.dtbo /lib/firmware/6.1.0-1025-rockchip/device-tree/rockchip/overlay/rk3568-uart3-m0.dtbo
        append root=UUID=cb911622-d31a-45b1-be03-e6467c1b7637 rootwait rw console=ttyS2,1500000 console=tty1 cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory

label l0r
        menu label Ubuntu 24.04.1 LTS 6.1.0-1025-rockchip (rescue target)
        linux /boot/vmlinuz-6.1.0-1025-rockchip
        initrd /boot/initrd.img-6.1.0-1025-rockchip
        fdt /lib/firmware/6.1.0-1025-rockchip/device-tree/rockchip/rk3588s-orangepi-5.dtb
        append root=UUID=cb911622-d31a-45b1-be03-e6467c1b7637 rootwait rw console=ttyS2,1500000 console=tty1 cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory single


